var app=angular.module("app",["ui.router","ngTouch"]);angular.module("ngTouch",[]).directive("ngTouchstart",function(){return{controller:["$scope","$element",function(e,t){function o(o){var r=t.attr("ng-touchstart");e.$apply(r)}t.bind("touchstart",o)}]}}).directive("ngTouch",function(){return{controller:["$scope","$element",function(e,t){var o,r,n,s;t.bind("touchstart",function(e){o=e.touches[0].pageX,r=e.touches[0].pageY}),t.bind("touchmove",function(e){n=e.touches[0].pageX,s=e.touches[0].pageY}),t.bind("touchend",function(c){if(n=n||o,s=s||r,Math.abs(o-n)<5&&Math.abs(r-s)<5){var a=t.attr("ng-touch");e.$apply(a)}})}]}}).directive("ngTouchmove",function(){return{controller:["$scope","$element",function(e,t){function o(e){e.preventDefault(),t.bind("touchmove",r),t.bind("touchend",n)}function r(o){var r=t.attr("ng-touchmove");e.$apply(r)}function n(e){e.preventDefault(),t.unbind("touchmove",r),t.unbind("touchend",n)}t.bind("touchstart",o)}]}}).directive("ngTouchend",function(){return{controller:["$scope","$element",function(e,t){function o(o){var r=t.attr("ng-touchend");e.$apply(r)}t.bind("touchend",o)}]}}),app.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/search-by-name"),e.state("home",{url:"/home",templateUrl:"dist/tpls/home.html",controller:"home"}).state("cart",{url:"/my-shopping-cart",templateUrl:"dist/tpls/cart.html",controller:"cart"}).state("order",{url:"/my-orders",templateUrl:"dist/tpls/order.html",controller:"order"}).state("orderManage",{url:"/orderManage",templateUrl:"dist/tpls/orderManage.html",controller:"orderManage"}).state("checkOrder",{url:"/checkOrder",templateUrl:"dist/tpls/checkOrder.html",controller:"checkOrder"}).state("address",{url:"/address",templateUrl:"dist/tpls/address.html",controller:"address"}).state("address_add",{url:"/address_add",templateUrl:"dist/tpls/address_add.html",controller:"address_add"}).state("searchByName",{url:"/search-by-name",templateUrl:"dist/tpls/searchByName.html",controller:"searchByName"}).state("searchByPdf",{url:"/search-pdf",templateUrl:"dist/tpls/search-pdf.html",controller:"searchByPdf"}).state("contact",{url:"/my-contact",templateUrl:"dist/tpls/contact.html",controller:"contact"})}]),app.controller("index",["$scope","$location","appid","weixin","dailog","searchByName",function(e,t,o,r,n,s){console.log(r.getUserInfo()),e.closeFix=function(){n.hide()},e.concat=function(){var e=r.getUserInfo().openId;s.concat({openId:e}).then(function(e){n.hideLoad(),"200"==e.status&&r.getMessage(r.getUserInfo().openId).success(function(e){"1"==e[0].subscribe?wx.closeWindow():location.href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI3MTY2NjIwNg==&scene=124#wechat_redirect"})})}}]),app.controller("home",["$scope",function(e){}]),app.controller("cart",["$scope","cart","weixin","$rootScope","$state",function(e,t,o,r,n){e.shops=o.getUserInfo().cart,e.reload=function(){e.totalPrice=t.totalPrice(e.shops),e.totalNum=t.totalNum(e.shops),o.setUserInfo("cart",e.shops)},e.reload(),e.addNum=function(t){e.shops[t].num++,e.changeNum(t)},e.subNum=function(t){e.shops[t].num--,e.shops[t].num<1&&(e.shops[t].num=1),e.changeNum(t)},e.changeSelect=function(t){e.shops[t].selected=!e.shops[t].selected,e.reload()},e.deleteShop=function(t){e.shops.splice(t,1),e.reload()},e.changeNum=function(t){for(var o=0;o<e.shops[t].prices.length;o++)e.shops[t].prices[o].selected=!1;for(var o=0;o<e.shops[t].prices.length;o++){if(parseInt(e.shops[t].prices[o].amount)<=parseInt(e.shops[t].num)&&e.shops[t].prices[o+1]&&parseInt(e.shops[t].prices[o+1].amount)>parseInt(e.shops[t].num))return e.shops[t].prices[o].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[o].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();if(e.shops[t].prices.length-1==o&&parseInt(e.shops[t].num)<e.shops[t].prices[0].amount)return e.shops[t].prices[0].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[o].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();e.shops[t].prices.length-1==o&&(e.shops[t].prices[o].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[o].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),e.reload())}},e.checkOrder=function(){r.selectShop=t.findSelected(e.shops),n.go("checkOrder")}}]),app.controller("order",["$scope","order","weixin","$state","dailog",function(e,t,o,r,n){t.getOrdersById(o.getUserInfo().openId).then(function(t){n.hideLoad(),e.orders=t.data}),e.current=!1,e.showCurrent=function(t){e.currentShop=e.orders[t],e.current=!0},e.hideCurrent=function(){setTimeout(function(){e.current=!1,e.$apply()},300)},e.goback=function(){r.go(-1)}}]),app.controller("orderManage",["$scope","order","weixin","$state","dailog",function(e,t,o,r,n){t.getOrders().then(function(t){e.orders=t.data}),e.current=!1,e.name="",e.id="",e.showCurrent=function(t){e.currentShop=e.orders[t],e.current=!0},e.hideCurrent=function(){setTimeout(function(){e.current=!1,e.$apply()},300)},e.goback=function(){r.go(-1)},e.write=function(){t.expressed({ownerOpenId:e.current.ownerOpenId,orderId:o.getUserInfo().openId,express:{name:e.name,id:e.id}}).then(function(e){n.hideLoad(),"ok"==e.data.msg&&n.show()})},e.closeFix=function(){r.go("orderManage")}}]),app.controller("checkOrder",["$scope","$rootScope","weixin","dailog","checkOrder",function(e,t,o,r,n){e.shopPrice=function(){for(var t=0,o=0;o<e.shops.length;o++)t+=parseFloat(e.shops[o].singlePrice);return t},e.num=function(){for(var t=0,o=0;o<e.shops.length;o++)t+=parseInt(e.shops[o].num);return t},e.closeFix=function(){r.hide("order")},e.pay=function(){n.addOrder({buyer:{name:e.address.name,phone:e.address.phone,addr:e.address.addr,zipCode:e.address.zipCode},subOrders:s,totalPrice:e.shopTotalPrice,ownerOpenId:o.getUserInfo().openId}).then(function(e){r.hideLoad(),"ok"==e.data.msg&&r.show()})},t.currentAddr?e.address=t.currentAddr:o.getMessage(o.getUserInfo().openId).then(function(o){r.hideLoad(),t.AllAddr=o.data[0].receiveAddrs,e.address=t.AllAddr[0]}),console.log(t.selectShop),e.shops=t.selectShop;for(var s=[],c=0;c<t.selectShop.length;c++){s[c]={},s[c].partName=t.selectShop[c].shopName,s[c].qty=t.selectShop[c].num;for(var a=0;a<t.selectShop[c].prices.length;a++)if(t.selectShop[c].prices[a].selected){s[c].price=t.selectShop[c].prices[a].changePrice;break}}e.shopTotalPrice=e.shopPrice(),e.totalNum=e.num()}]),app.controller("address",["$scope","weixin","$rootScope","$state","dailog",function(e,t,o,r,n){var s=t.getUserInfo().openId;t.getMessage(s).then(function(t){n.hideLoad(),e.address=t.data[0].receiveAddrs,o.AllAddr=e.address}),e.changeAddress=function(t){o.currentAddr=e.address[t],setTimeout(function(){r.go("checkOrder")},300)}}]),app.controller("address_add",["$scope","address_add","weixin","dailog",function(e,t,o,r){e.tel="",e.name="",e.address="",e.zipCode="",e.closeFix=function(){r.hide("address")},e.submit=function(){t.submit({openId:o.getUserInfo().openId,receiveAddr:{phone:e.tel,name:e.name,addr:e.address,zipCode:e.zipCode}}).then(function(e){r.hideLoad(),"ok"==e.data.msg&&r.show("新增成功")})}}]),app.controller("searchByName",["$scope","searchByName","$rootScope","weixin","dailog",function(e,t,o,r,n){e.showList=!1,e.noList=!1,r.config(),t.rate().success(function(e){n.hideLoad(),o.rate=e,o.rate.push({name:"RMB",rate:100})}),e.submit=function(){e.searchName&&t.search({part:encodeURIComponent(e.searchName)}).success(function(o){if(n.hideLoad(),!o.distributors||0==o.distributors.length&&0==o.icKeys.length)return e.showList=!1,void(e.noList=!0);e.noList=!1,e.showList=!0;for(var r=0;r<o.icKeys.length;r++)"云汉芯城"==o.icKeys[r].name&&(o.icKeys[r].name="ic购商城",o.distributors.push(o.icKeys[r]));for(var s=0;o.distributors.length<3&&o.icKeys[s];)t.hasItem(o.distributors,o.icKeys[s])||o.distributors.push(o.icKeys[s]),s++;e.list=t.changePrice(o.distributors)})},e.addToCart=function(t,o){var s=e.list[t].parts[o];s.name=e.list[t].name,s.shopName=e.searchName,s.singlePrice=s.prices[0].changePrice,s.selected=!0;var c=r.getUserInfo().cart,a=e.hasShop(s.maker,s.name);a.msg?c[a.index].num++:(s.num=1,c.push(s)),r.setUserInfo("cart",c),setTimeout(function(){n.show()},300)},e.hasShop=function(e,t){for(var o=0;o<r.getUserInfo().cart.length;o++)if(r.getUserInfo().cart[o].maker==e&&r.getUserInfo().cart[o].name==t)return{msg:!0,index:o};return{msg:!1}}}]),app.controller("searchByPdf",["$scope","searchPdf","dailog","weixin",function(e,t,o,r){r.config(),e.submit=function(){e.searchPdf&&t.search({part:encodeURIComponent(e.searchPdf)}).success(function(t){if(o.hideLoad(),"not found"==t.msg)return e.showList=!1,void(e.noList=!0);e.noList=!1,e.showList=!0,e.list=t.pdfs2})}}]),app.controller("contact",["$scope","contact","weixin","dailog",function(e,t,o,r){e.submit=function(){t.submit({openId:o.getUserInfo().openId,phone:e.tel}).then(function(t){r.hideLoad(),"ok"==t.data.msg?(e.success=!0,e.getPhone()):e.success=!1},function(){e.success=!1})},e.getPhone=function(){o.getMessage(o.getUserInfo().openId).success(function(t){r.hideLoad(),t[0].phone?(e.phone=t[0].phone,e.hasPhone=!0,e.placeholder="更新手机号码"):(e.hasPhone=!1,e.placeholder="请填写手机号码")})},e.success=!1,e.getPhone()}]),app.directive("swiper",function(){return{scope:{},restrict:"AE",template:'<div class="swiper-container"><div class="swiper-wrapper" ng-transclude></div><div class="swiper-pagination"></div></div>',transclude:!0}}),app.filter("changRate",["$rootScope",function(e){return function(t,o){for(var r=0;r<e.rate.length;r++)if(e.rate[r].name==o)return t=t*e.rate[r].rate/100,t.toFixed(2)}}]),app.constant("appid","wx72b8722be094d273"),app.constant("host","https://chip.jymao.com"),app.factory("dailog",["$state",function(e){return{show:function(e){var t=document.querySelector(".message"),o=document.querySelector(".message p");t.style.display="block",e&&(o.innerText=e)},hide:function(t){document.querySelector(".message").style.display="none",t&&e.go(t)},showLoad:function(){document.querySelector(".load").style.display="block"},hideLoad:function(){document.querySelector(".load").style.display="none"}}}]),app.factory("weixin",["appid","host","$http","dailog",function(e,t,o,r){return{url:"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+e+"&redirect_uri="+encodeURIComponent(window.location.href)+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect",isweixin:function(){return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)},getQueryString:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),o=window.location.search.substr(1).match(t);return null!=o?unescape(o[2]):null},getUser:function(e){console.log(e);var o=new XMLHttpRequest;o.open("POST",t+"/wx/code",!1),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status){var e=JSON.parse(o.responseText);e.cart=[],localStorage.setItem("MY_USER_INFO",JSON.stringify(e))}else console.error(o.statusText)},o.onerror=function(e){console.error(o.statusText)},o.send("code="+e)},getUserInfo:function(){return null!=localStorage.getItem("MY_USER_INFO")?JSON.parse(localStorage.getItem("MY_USER_INFO")):null!=this.getQueryString("code")?(this.getUser(this.getQueryString("code")),JSON.parse(localStorage.getItem("MY_USER_INFO"))):void(window.location.href=this.url)},setUserInfo:function(e,t){var o=this.getUserInfo();o[e]=t,localStorage.setItem("MY_USER_INFO",JSON.stringify(o))},getMessage:function(e){return r.showLoad(),o.get(t+"/ds/g/WxUser?condition[openId]="+e)},getNonceStr:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(36)})},getTs:function(){return Math.floor((new Date).getTime()/100).toString()},config:function(){var r=this.getNonceStr(),n=this.getTs();o.get(t+"/wx/js-api-sign",{params:{noncestr:r,ts:n,url:encodeURIComponent(location.href)}}).success(function(t){wx.config({debug:!0,appId:e,timestamp:n,nonceStr:r,signature:t.sign,jsApiList:["closeWindow"]})})}}}]),app.factory("swipe",[function(){return function(){setTimeout(function(){new Swiper(".swiper-container",{loop:!0,pagination:".swiper-pagination"})},10)}}]),app.factory("cart",[function(){return{totalPrice:function(e){for(var t=0,o=0;o<e.length;o++)e[o].selected&&(t+=parseFloat(e[o].singlePrice));return t},totalNum:function(e){for(var t=0,o=0;o<e.length;o++)e[o].selected&&(t+=e[o].num);return t},findSelected:function(e){for(var t=[],o=0;o<e.length;o++)e[o].selected&&t.push(e[o]);return t}}}]),app.factory("searchByName",["$http","host","$filter","dailog",function(e,t,o,r){return{search:function(o){return r.showLoad(),e.get(t+"/ds/search-price",{params:o})},rate:function(o){return e.get(t+"/ds/g/Exchange",{params:o})},concat:function(o){return r.showLoad(),e({method:"post",data:o,url:t+"/wx/contact-kf"})},changePrice:function(e){for(var t=0;t<e.length;t++)for(var r=0;r<e[t].parts.length;r++)for(var n=0;n<e[t].parts[r].prices.length;n++)e[t].parts[r].prices[n].changePrice=o("changRate")(e[t].parts[r].prices[n].price,e[t].parts[r].prices[n].currency),"ic购商城"==e[t].name&&(e[t].parts[r].prices[n].changePrice=(.95*e[t].parts[r].prices[n].changePrice).toFixed(2)),e[t].parts[r].prices[n].selected=0==n;return e},hasItem:function(e,t){for(var o=0;o<e.length;o++)if(e[o].name.trim()==t.name.trim())return!0;return!1}}}]),app.factory("searchPdf",["$http","host","dailog",function(e,t,o){return{search:function(r){return o.showLoad(),e.get(t+"/ds/search-pdf",{params:r})},concat:function(r){return o.showLoad(),e({method:"post",data:r,url:t+"/wx/contact-kf"})}}}]),app.factory("contact",["$http","host","dailog",function(e,t,o){return{submit:function(r){return o.showLoad(),e({method:"post",data:r,url:t+"/ds/wx-user/phone"})}}}]),app.factory("address_add",["$http","host","dailog",function(e,t,o){return{submit:function(r){return o.showLoad(),e({method:"post",data:r,url:t+"/ds/wx-user/receive-addr"})}}}]),app.factory("checkOrder",["$http","host","dailog",function(e,t,o){return{addOrder:function(r){return o.showLoad(),e({method:"post",data:r,url:t+"/ds/order"})}}}]),app.factory("order",["$http","host","dailog",function(e,t,o){return{getOrdersById:function(r){return o.showLoad(),e.get(t+"/ds/g/Order?condition[ownerOpenId]="+r)},getOrders:function(){return o.showLoad(),e.get(t+"/ds/g/Order")},expressed:function(r){return o.showLoad(),e({method:"post",data:r,url:t+"/ds/order/expressed"})}}}]);