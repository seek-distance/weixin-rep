var app=angular.module("app",["ui.router","ngTouch"]);angular.module("ngTouch",[]).directive("ngTouchstart",function(){return{controller:["$scope","$element",function(e,t){function o(o){var n=t.attr("ng-touchstart");e.$apply(n)}t.bind("touchstart",o)}]}}).directive("ngTouch",function(){return{controller:["$scope","$element",function(e,t){var o,n,r,s;t.bind("touchstart",function(e){o=e.touches[0].pageX,n=e.touches[0].pageY}),t.bind("touchmove",function(e){r=e.touches[0].pageX,s=e.touches[0].pageY}),t.bind("touchend",function(c){if(r=r||o,s=s||n,Math.abs(o-r)<5&&Math.abs(n-s)<5){var a=t.attr("ng-touch");e.$apply(a)}})}]}}).directive("ngTouchmove",function(){return{controller:["$scope","$element",function(e,t){function o(e){e.preventDefault(),t.bind("touchmove",n),t.bind("touchend",r)}function n(o){var n=t.attr("ng-touchmove");e.$apply(n)}function r(e){e.preventDefault(),t.unbind("touchmove",n),t.unbind("touchend",r)}t.bind("touchstart",o)}]}}).directive("ngTouchend",function(){return{controller:["$scope","$element",function(e,t){function o(o){var n=t.attr("ng-touchend");e.$apply(n)}t.bind("touchend",o)}]}}),app.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/search-by-name"),e.state("home",{url:"/home",templateUrl:"dist/tpls/home.html",controller:"home"}).state("cart",{url:"/my-shopping-cart",templateUrl:"dist/tpls/cart.html",controller:"cart"}).state("order",{url:"/my-orders",cache:"false",templateUrl:"dist/tpls/order.html",controller:"order"}).state("checkOrder",{url:"/checkOrder",templateUrl:"dist/tpls/checkOrder.html",controller:"checkOrder"}).state("address",{url:"/address",templateUrl:"dist/tpls/address.html",controller:"address"}).state("address_add",{url:"/address_add",templateUrl:"dist/tpls/address_add.html",controller:"address_add"}).state("searchByName",{url:"/search-by-name",templateUrl:"dist/tpls/searchByName.html",controller:"searchByName"}).state("searchByPdf",{url:"/search-pdf",templateUrl:"dist/tpls/search-pdf.html",controller:"searchByPdf"}).state("contact",{url:"/my-contact",templateUrl:"dist/tpls/contact.html",controller:"contact"})}]),app.controller("index",["$scope","$location","weixin","dailog","searchByName",function(e,t,o,n,r){console.log(o.getUserInfo()),e.closeFix=function(){n.hide()},e.concat=function(){var e=o.getUserInfo().openId;r.concat({openId:e}).then(function(e){n.hideLoad(),"200"==e.status&&o.getMessage(o.getUserInfo().openId).success(function(e){"1"==e[0].subscribe?wx.closeWindow():location.href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI3MTY2NjIwNg==&scene=124#wechat_redirect"})})}}]),app.controller("home",["$scope",function(e){}]),app.controller("cart",["$scope","cart","weixin","$rootScope","$state","$timeout",function(e,t,o,n,r,s){e.shops=o.getUserInfo().cart,e.reload=function(){e.totalPrice=t.totalPrice(e.shops),e.totalNum=t.totalNum(e.shops),o.setUserInfo("cart",e.shops)},e.addNum=function(t){e.shops[t].num++,e.changeNum(t)},e.subNum=function(t){e.shops[t].num--,e.shops[t].num<1&&(e.shops[t].num=1),e.changeNum(t)},e.changeSelect=function(t){e.shops[t].selected=!e.shops[t].selected,e.reload()},e.deleteShop=function(t){e.shops.splice(t,1),e.reload()},e.changeNum=function(t){for(var o=0;o<e.shops[t].prices.length;o++)e.shops[t].prices[o].selected=!1;for(var o=0;o<e.shops[t].prices.length;o++){if(parseInt(e.shops[t].prices[o].amount)<=parseInt(e.shops[t].num)&&e.shops[t].prices[o+1]&&parseInt(e.shops[t].prices[o+1].amount)>parseInt(e.shops[t].num))return e.shops[t].prices[o].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[o].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();if(e.shops[t].prices.length-1==o&&parseInt(e.shops[t].num)<e.shops[t].prices[0].amount)return e.shops[t].prices[0].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[o].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();e.shops[t].prices.length-1==o&&(e.shops[t].prices[o].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[o].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),e.reload())}},e.checkOrder=function(){n.selectShop=t.findSelected(e.shops),r.go("checkOrder")},e.reload();for(var c=0;c<e.shops.length;c++)e.changeNum(c)}]),app.controller("order",["$scope","order","weixin","$state","dailog",function(e,t,o,n,r){o.config(),t.getOrdersById(o.getUserInfo().openId).then(function(t){r.hideLoad(),e.orders=t.data}),e.current=!1,e.showCurrent=function(t){e.scrollTop=document.body.scrollTop,e.currentShop=e.orders[t],e.current=!0},e.hideCurrent=function(){setTimeout(function(){e.current=!1,e.$apply(),document.body.scrollTop=e.scrollTop},300)},e.goback=function(){n.go(-1)},e.pay=function(e,t){t.stopPropagation(),o.pay(e)}}]),app.controller("checkOrder",["$scope","$rootScope","weixin","dailog","checkOrder","cart","$state",function(e,t,o,n,r,s,c){o.config(),e.shopPrice=function(){for(var t=0,o=0;o<e.shops.length;o++)t+=parseFloat(e.shops[o].singlePrice);return t},e.num=function(){for(var t=0,o=0;o<e.shops.length;o++)t+=parseInt(e.shops[o].num);return t},e.closeFix=function(){n.hide("order")},e.pay=function(){r.addOrder({buyer:{name:e.address.name,phone:e.address.phone,addr:e.address.addr,zipCode:e.address.zipCode},subOrders:a,totalPrice:100*e.shopTotalPrice,ownerOpenId:o.getUserInfo().openId,descr:a[0].partName}).then(function(e){n.hideLoad(),s.removeSelected(),c.go("order")})},t.currentAddr?e.address=t.currentAddr:o.getMessage(o.getUserInfo().openId).then(function(o){n.hideLoad(),t.AllAddr=o.data[0].receiveAddrs,e.address=t.AllAddr[0]}),e.shops=t.selectShop;for(var a=[],i=0;i<t.selectShop.length;i++){a[i]={},a[i].partName=t.selectShop[i].shopName,a[i].qty=t.selectShop[i].num;for(var d=0;d<t.selectShop[i].prices.length;d++)if(t.selectShop[i].prices[d].selected){a[i].price=t.selectShop[i].prices[d].changePrice;break}}e.shopTotalPrice=e.shopPrice(),e.totalNum=e.num()}]),app.controller("address",["$scope","weixin","$rootScope","$state","dailog",function(e,t,o,n,r){var s=t.getUserInfo().openId;t.getMessage(s).then(function(t){r.hideLoad(),e.address=t.data[0].receiveAddrs,o.AllAddr=e.address}),e.changeAddress=function(t){o.currentAddr=e.address[t],setTimeout(function(){n.go("checkOrder")},300)}}]),app.controller("address_add",["$scope","address_add","weixin","dailog",function(e,t,o,n){e.tel="",e.name="",e.address="",e.zipCode="",e.closeFix=function(){n.hide("address")},e.submit=function(){t.submit({openId:o.getUserInfo().openId,receiveAddr:{phone:e.tel,name:e.name,addr:e.address,zipCode:e.zipCode}}).then(function(e){n.hideLoad(),"ok"==e.data.msg&&n.show("新增成功")})}}]),app.controller("searchByName",["$scope","searchByName","$rootScope","weixin","dailog",function(e,t,o,n,r){e.showList=!1,e.noList=!1,e.lists=[],n.config(),t.rate().success(function(e){r.hideLoad(),o.rate=e,o.rate.push({name:"RMB",rate:100})}),e.submit=function(){e.searchName&&t.search({part:encodeURIComponent(e.searchName)}).success(function(t){r.hideLoad(),e.lists=e.getLists(t),console.log(e.lists)})},e.addToCart=function(t,o,s){var c=e.lists[t].list[o].parts[s];c.name=e.lists[t].list[o].name,c.shopName=e.lists[t].oldName,c.singlePrice=c.prices[0].changePrice,c.selected=!0;var a=n.getUserInfo().cart,i=e.hasShop(c.maker,c.name);i.msg?a[i.index].num++:(c.num=1,a.push(c)),n.setUserInfo("cart",a),setTimeout(function(){r.show()},300)},e.hasShop=function(e,t){for(var o=0;o<n.getUserInfo().cart.length;o++)if(n.getUserInfo().cart[o].maker==e&&n.getUserInfo().cart[o].name==t)return{msg:!0,index:o};return{msg:!1}},e.showItem=function(t){e.lists[t].show=!e.lists[t].show},e.getLists=function(o){var n=[],r=!1;if("not found"==o.msg)return e.showList=!1,void(e.noList=!0);for(var s=0;s<o.length;s++)if(!o[s].distributors||0==o[s].distributors.length&&0==o[s].icKeys.length)r||(e.showList=!1,e.noList=!0);else{r=!0,e.noList=!1,e.showList=!0;for(var c=0;c<o[s].icKeys.length;c++)"云汉芯城"==o[s].icKeys[c].name&&(o[s].icKeys[c].name="ic购商城",o[s].distributors.splice(0,0,o[s].icKeys[c]));for(var a=0;o[s].distributors.length<3&&o[s].icKeys[a]&&(t.hasItem(o[s].distributors,o[s].icKeys[a])||o[s].distributors.push(o[s].icKeys[a]),!(++a>10)););var i=o[s].name.indexOf(e.searchName),d=i+e.searchName.length,p=o[s].name.slice(0,i),u=o[s].name.slice(i,d),l=o[s].name.slice(d),h={list:t.changePrice(o[s].distributors),name:[p,u,l],oldName:o[s].name};n.push(h)}return n}}]),app.controller("searchByPdf",["$scope","searchPdf","dailog","weixin",function(e,t,o,n){e.lists=[],n.config(),e.submit=function(){e.searchPdf&&t.search({part:encodeURIComponent(e.searchPdf)}).success(function(t){if(e.lists=[],o.hideLoad(),"not found"==t.msg)return e.showList=!1,void(e.noList=!0);e.noList=!1,e.showList=!0;for(var n=0;n<t.length;n++){var r={name:t[n].name,list:t[n].pdfs2};e.lists.push(r)}})}}]),app.controller("contact",["$scope","contact","weixin","dailog",function(e,t,o,n){e.submit=function(){t.submit({openId:o.getUserInfo().openId,phone:e.tel}).then(function(t){n.hideLoad(),"ok"==t.data.msg?(e.success=!0,e.getPhone()):e.success=!1},function(){e.success=!1})},e.getPhone=function(){o.getMessage(o.getUserInfo().openId).success(function(t){n.hideLoad(),t[0].phone?(e.phone=t[0].phone,e.hasPhone=!0,e.placeholder="更新手机号码"):(e.hasPhone=!1,e.placeholder="请填写手机号码")})},e.success=!1,e.getPhone()}]),app.directive("swiper",function(){return{scope:{},restrict:"AE",template:'<div class="swiper-container"><div class="swiper-wrapper" ng-transclude></div><div class="swiper-pagination"></div></div>',transclude:!0}}),app.filter("changRate",["$rootScope",function(e){return function(t,o){for(var n=0;n<e.rate.length;n++)if(e.rate[n].name==o)return t=t*e.rate[n].rate/100,t.toFixed(2)}}]),app.constant("appId","wx72b8722be094d273"),app.constant("host","https://chip.jymao.com"),app.factory("dailog",["$state",function(e){return{show:function(e){var t=document.querySelector(".message"),o=document.querySelector(".message p");t.style.display="block",e&&(o.innerText=e)},hide:function(t){document.querySelector(".message").style.display="none",t&&e.go(t)},showLoad:function(){document.querySelector(".load").style.display="block"},hideLoad:function(){document.querySelector(".load").style.display="none"}}}]),app.factory("weixin",["appId","host","$http","dailog","$state","$timeout",function(e,t,o,n,r,s){return{url:"https://open.weixin.qq.com/connect/oauth2/authorize?appId="+e+"&redirect_uri="+encodeURIComponent(window.location.href)+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect",isweixin:function(){return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)},getQueryString:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),o=window.location.search.substr(1).match(t);return null!=o?unescape(o[2]):null},getUser:function(e){var o=new XMLHttpRequest;o.open("POST",t+"/wx/code",!1),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status){var e=JSON.parse(o.responseText);e.cart=[],localStorage.setItem("MY_USER_INFO",JSON.stringify(e))}else console.error(o.statusText)},o.onerror=function(e){console.error(o.statusText)},o.send("code="+e)},getUserInfo:function(){return null!=localStorage.getItem("MY_USER_INFO")?JSON.parse(localStorage.getItem("MY_USER_INFO")):null!=this.getQueryString("code")?(this.getUser(this.getQueryString("code")),JSON.parse(localStorage.getItem("MY_USER_INFO"))):void(window.location.href=this.url)},setUserInfo:function(e,t){var o=this.getUserInfo();o[e]=t,localStorage.setItem("MY_USER_INFO",JSON.stringify(o))},getMessage:function(e){return n.showLoad(),o.get(t+"/ds/g/WxUser?condition[openId]="+e)},getNonceStr:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(36)})},getTs:function(){return Math.floor((new Date).getTime()/100).toString()},config:function(){var n=this.getNonceStr(),r=this.getTs();o.get(t+"/wx/js-api-sign",{params:{noncestr:n,ts:r,url:encodeURIComponent(location.href)}}).success(function(t){wx.config({debug:!1,appId:e,timestamp:r,nonceStr:n,signature:t.sign,jsApiList:["closeWindow","chooseWXPay"]})})},pay:function(e){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",o,function(e){r.go("order"),s(function(){location.reload()},300)})}var o={};this.getPayOption(e).success(function(e){o=e,"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",t,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",t),document.attachEvent("onWeixinJSBridgeReady",t)):t()})},getPayOption:function(e){return o.post(t+"/ds/order/wx-pay-order",{orderId:e})}}}]),app.factory("swipe",[function(){return function(){setTimeout(function(){new Swiper(".swiper-container",{loop:!0,pagination:".swiper-pagination"})},10)}}]),app.factory("cart",["weixin",function(e){return{totalPrice:function(e){for(var t=0,o=0;o<e.length;o++)e[o].selected&&(t+=parseFloat(e[o].singlePrice));return t},totalNum:function(e){for(var t=0,o=0;o<e.length;o++)e[o].selected&&(t+=e[o].num);return t},findSelected:function(e){for(var t=[],o=0;o<e.length;o++)e[o].selected&&t.push(e[o]);return t},removeSelected:function(){for(var t=e.getUserInfo().cart,o=t.length-1;o>=0;o--)t[o].selected&&t.splice(o,1);e.setUserInfo("cart",t)}}}]),app.factory("searchByName",["$http","host","$filter","dailog",function(e,t,o,n){return{search:function(o){return n.showLoad(),e.get(t+"/ds/search-price",{params:o})},rate:function(o){return e.get(t+"/ds/g/Exchange",{params:o})},concat:function(o){return n.showLoad(),e({method:"post",data:o,url:t+"/wx/contact-kf"})},changePrice:function(e){for(var t=0;t<e.length;t++)for(var n=0;n<e[t].parts.length;n++)if(e[t].parts[n].prices)for(var r=0;r<e[t].parts[n].prices.length;r++)e[t].parts[n].prices[r].changePrice=o("changRate")(e[t].parts[n].prices[r].price,e[t].parts[n].prices[r].currency),"ic购商城"==e[t].name&&(e[t].parts[n].prices[r].changePrice=(.95*e[t].parts[n].prices[r].changePrice).toFixed(2)),e[t].parts[n].prices[r].selected=0==r;return e},hasItem:function(e,t){for(var o=0;o<e.length;o++)if(e[o].name.trim()==t.name.trim())return!0;return!1}}}]),app.factory("searchPdf",["$http","host","dailog",function(e,t,o){return{search:function(n){return o.showLoad(),e.get(t+"/ds/search-pdf",{params:n})},concat:function(n){return o.showLoad(),e({method:"post",data:n,url:t+"/wx/contact-kf"})}}}]),app.factory("contact",["$http","host","dailog",function(e,t,o){return{submit:function(n){return o.showLoad(),e({method:"post",data:n,url:t+"/ds/wx-user/phone"})}}}]),app.factory("address_add",["$http","host","dailog",function(e,t,o){return{submit:function(n){return o.showLoad(),e({method:"post",data:n,url:t+"/ds/wx-user/receive-addr"})}}}]),app.factory("checkOrder",["$http","host","dailog",function(e,t,o){return{addOrder:function(n){return o.showLoad(),e({method:"post",data:n,url:t+"/ds/order"})}}}]),app.factory("order",["$http","host","dailog",function(e,t,o){return{getOrdersById:function(n){return o.showLoad(),e.get(t+"/ds/g/Order?condition[ownerOpenId]="+n)},getOrders:function(){return o.showLoad(),e.get(t+"/ds/g/Order")},expressed:function(n){return o.showLoad(),e({method:"post",data:n,url:t+"/ds/order/expressed"})}}}]);