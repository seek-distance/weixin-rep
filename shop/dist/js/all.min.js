var app=angular.module("app",["ui.router","ngTouch"]);angular.module("ngTouch",[]).directive("ngTouchstart",function(){return{controller:["$scope","$element",function(e,t){function r(r){var n=t.attr("ng-touchstart");e.$apply(n)}t.bind("touchstart",r)}]}}).directive("ngTouch",function(){return{controller:["$scope","$element",function(e,t){function r(r){var n=t.attr("ng-touch");e.$apply(n)}t.bind("touchstart",r)}]}}).directive("ngTouchmove",function(){return{controller:["$scope","$element",function(e,t){function r(e){e.preventDefault(),t.bind("touchmove",n),t.bind("touchend",o)}function n(r){var n=t.attr("ng-touchmove");e.$apply(n)}function o(e){e.preventDefault(),t.unbind("touchmove",n),t.unbind("touchend",o)}t.bind("touchstart",r)}]}}).directive("ngTouchend",function(){return{controller:["$scope","$element",function(e,t){function r(r){var n=t.attr("ng-touchend");e.$apply(n)}t.bind("touchend",r)}]}}),app.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/home"),e.state("home",{url:"/home",templateUrl:"dist/tpls/home.html",controller:"home"}).state("cart",{url:"/my-shopping-cart",templateUrl:"dist/tpls/cart.html",controller:"cart"}).state("order",{url:"/my-orders",templateUrl:"dist/tpls/order.html",controller:"order"}).state("orderManage",{url:"/orderManage",templateUrl:"dist/tpls/orderManage.html",controller:"orderManage"}).state("user",{url:"/user",templateUrl:"dist/tpls/user.html",controller:"user"}).state("checkOrder",{url:"/checkOrder",templateUrl:"dist/tpls/checkOrder.html",controller:"checkOrder"}).state("address",{url:"/address",templateUrl:"dist/tpls/address.html",controller:"address"}).state("address_add",{url:"/address_add",templateUrl:"dist/tpls/address_add.html",controller:"address_add"}).state("searchByName",{url:"/search-by-name",templateUrl:"dist/tpls/searchByName.html",controller:"searchByName"}).state("searchByPdf",{url:"/search-pdf",templateUrl:"dist/tpls/search-pdf.html",controller:"searchByPdf"}).state("contact",{url:"/my-contact",templateUrl:"dist/tpls/contact.html",controller:"contact"})}]),app.controller("index",["$scope","$location","appid","weixin",function(e,t,r,n){console.log(n.getUserInfo())}]),app.controller("home",["$scope",function(e){}]),app.controller("cart",["$scope","cart","weixin","$rootScope","$state",function(e,t,r,n,o){e.shops=r.getUserInfo().cart,e.reload=function(){e.totalPrice=t.totalPrice(e.shops),e.totalNum=t.totalNum(e.shops),r.setUserInfo("cart",e.shops)},e.reload(),e.addNum=function(t){e.shops[t].num++,e.changeNum(t)},e.subNum=function(t){e.shops[t].num--,e.shops[t].num<1&&(e.shops[t].num=1),e.changeNum(t)},e.changeSelect=function(t){e.shops[t].selected=!e.shops[t].selected,e.reload()},e.deleteShop=function(t){e.shops.splice(t,1),e.reload()},e.changeNum=function(t){for(var r=0;r<e.shops[t].prices.length;r++)e.shops[t].prices[r].selected=!1;for(var r=0;r<e.shops[t].prices.length;r++){if(parseInt(e.shops[t].prices[r].amount)<=parseInt(e.shops[t].num)&&e.shops[t].prices[r+1]&&parseInt(e.shops[t].prices[r+1].amount)>parseInt(e.shops[t].num))return e.shops[t].prices[r].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[r].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();if(e.shops[t].prices.length-1==r&&parseInt(e.shops[t].num)<e.shops[t].prices[0].amount)return e.shops[t].prices[0].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[r].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();e.shops[t].prices.length-1==r&&(e.shops[t].prices[r].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[r].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),e.reload())}},e.checkOrder=function(){n.selectShop=t.findSelected(e.shops),o.go("checkOrder")}}]),app.controller("order",["$scope","order","weixin","$state",function(e,t,r,n){t.getOrdersById(r.getUserInfo().openId).then(function(t){e.orders=t.data}),e.current=!1,e.showCurrent=function(t){e.currentShop=e.orders[t],e.current=!0},e.hideCurrent=function(){setTimeout(function(){e.current=!1,e.$apply()},300)},e.goback=function(){n.go(-1)}}]),app.controller("orderManage",["$scope","order","weixin","$state","dailog",function(e,t,r,n,o){t.getOrders().then(function(t){e.orders=t.data}),e.current=!1,e.name="",e.id="",e.showCurrent=function(t){e.currentShop=e.orders[t],e.current=!0},e.hideCurrent=function(){setTimeout(function(){e.current=!1,e.$apply()},300)},e.goback=function(){n.go(-1)},e.write=function(){t.expressed({ownerOpenId:e.current.ownerOpenId,orderId:r.getUserInfo().openId,express:{name:e.name,id:e.id}}).then(function(e){"ok"==e.data.msg&&o.show()})},e.closeFix=function(){n.go("orderManage")}}]),app.controller("user",["$scope","$rootScope",function(e,t){t.isLogin=!0}]),app.controller("checkOrder",["$scope","$rootScope","weixin","dailog","checkOrder",function(e,t,r,n,o){e.shopPrice=function(){for(var t=0,r=0;r<e.shops.length;r++)t+=parseFloat(e.shops[r].singlePrice);return t},e.num=function(){for(var t=0,r=0;r<e.shops.length;r++)t+=parseInt(e.shops[r].num);return t},e.closeFix=function(){n.hide("order")},e.pay=function(){o.addOrder({buyer:{name:e.address.name,phone:e.address.phone,addr:e.address.addr,zipCode:e.address.zipCode},subOrders:s,totalPrice:e.shopTotalPrice,ownerOpenId:r.getUserInfo().openId}).then(function(e){"ok"==e.data.msg&&n.show()})},t.currentAddr?e.address=t.currentAddr:r.getAddr(r.getUserInfo().openId).then(function(r){t.AllAddr=r.data[0].receiveAddrs,e.address=t.AllAddr[0]}),console.log(t.selectShop),e.shops=t.selectShop;for(var s=[],c=0;c<t.selectShop.length;c++){s[c]={},s[c].partName=t.selectShop[c].shopName,s[c].qty=t.selectShop[c].num;for(var a=0;a<t.selectShop[c].prices.length;a++)if(t.selectShop[c].prices[a].selected){s[c].price=t.selectShop[c].prices[a].changePrice;break}}e.shopTotalPrice=e.shopPrice(),e.totalNum=e.num()}]),app.controller("address",["$scope","weixin","$rootScope","$state",function(e,t,r,n){var o=t.getUserInfo().openId;t.getAddr(o).then(function(t){e.address=t.data[0].receiveAddrs,r.AllAddr=e.address}),e.changeAddress=function(t){r.currentAddr=e.address[t],setTimeout(function(){n.go("checkOrder")},300)}}]),app.controller("address_add",["$scope","address_add","weixin","dailog",function(e,t,r,n){e.tel="",e.name="",e.address="",e.zipCode="",e.closeFix=function(){n.hide("address")},e.submit=function(){t.submit({openId:r.getUserInfo().openId,receiveAddr:{phone:e.tel,name:e.name,addr:e.address,zipCode:e.zipCode}}).then(function(e){"ok"==e.data.msg&&n.show("新增成功")})}}]),app.controller("searchByName",["$scope","searchByName","$rootScope","weixin",function(e,t,r,n){e.showList=!1,e.noList=!1,t.rate().success(function(e){r.rate=e,r.rate.push({name:"RMB",rate:100})}),e.submit=function(){e.searchName&&t.search({part:e.searchName}).success(function(r){if(!r.distributors||0==r.distributors.length&&0==r.icKeys.length)return e.showList=!1,void(e.noList=!0);if(e.noList=!1,e.showList=!0,r.distributors.length<3){var n=3-r.distributors.length;Array.prototype.push.apply(r.distributors,r.icKeys.slice(0,n))}e.list=t.changePrice(r.distributors),console.log(e.list)})},e.concat=function(){var e=n.getUserInfo().openId;t.concat({openId:e}),location.href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI3MTY2NjIwNg==&scene=124#wechat_redirect"},e.addToCart=function(t,r){var o=e.list[t].parts[r];o.name=e.list[t].name,o.shopName=e.searchName,o.singlePrice=o.prices[0].changePrice,o.selected=!1;var s=n.getUserInfo().cart,c=e.hasShop(o.maker,o.name);c.msg?s[c.index].num++:(o.num=1,s.push(o)),n.setUserInfo("cart",s)},e.hasShop=function(e,t){for(var r=0;r<n.getUserInfo().cart.length;r++)if(n.getUserInfo().cart[r].maker==e&&n.getUserInfo().cart[r].name==t)return{msg:!0,index:r};return{msg:!1}}}]),app.controller("searchByPdf",["$scope","searchPdf",function(e,t){e.submit=function(){e.searchPdf&&t.search({part:e.searchPdf}).success(function(t){if(!t||0==t.pdfs.length)return e.showList=!1,void(e.noList=!0);e.noList=!1,e.showList=!0,e.list=t.pdfs})}}]),app.controller("contact",["$scope","contact","weixin",function(e,t,r){e.success=!1,e.submit=function(){t.submit({openId:r.getUserInfo().openId,phone:e.tel}).then(function(t){"ok"==t.data.msg?e.success=!0:e.success=!1},function(){e.success=!1})}}]),app.directive("swiper",function(){return{scope:{},restrict:"AE",template:'<div class="swiper-container"><div class="swiper-wrapper" ng-transclude></div><div class="swiper-pagination"></div></div>',transclude:!0}}),app.filter("changRate",["$rootScope",function(e){return function(t,r){for(var n=0;n<e.rate.length;n++)if(e.rate[n].name==r)return t=t*e.rate[n].rate/100,t.toFixed(2)}}]),app.constant("appid","wx72b8722be094d273"),app.constant("host","https://chip.jymao.com"),app.factory("dailog",["$state",function(e){return{show:function(e){var t=document.querySelector(".message"),r=document.querySelector(".message p");t.style.display="block",e&&(r.innerText=e)},hide:function(t){document.querySelector(".message").style.display="none",t&&e.go(t)}}}]),app.factory("weixin",["appid","host","$http",function(e,t,r){return{config:{url:"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+e+"&redirect_uri="+encodeURIComponent(window.location.href)+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect"},isweixin:function(){return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)},getQueryString:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),r=window.location.search.substr(1).match(t);return null!=r?unescape(r[2]):null},getUser:function(e){var r=new XMLHttpRequest;r.open("POST",t+"/wx/code",!1),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status){var e=JSON.parse(r.responseText);e.cart=[],localStorage.setItem("MY_USER_INFO",JSON.stringify(e))}else console.error(r.statusText)},r.onerror=function(e){console.error(r.statusText)},r.send("code="+e)},getUserInfo:function(){return null!=localStorage.getItem("MY_USER_INFO")?JSON.parse(localStorage.getItem("MY_USER_INFO")):null!=this.getQueryString("code")?(this.getUser(this.getQueryString("code")),JSON.parse(localStorage.getItem("MY_USER_INFO"))):void(window.location.href=this.config.url)},setUserInfo:function(e,t){var r=this.getUserInfo();r[e]=t,localStorage.setItem("MY_USER_INFO",JSON.stringify(r))},getAddr:function(e){return r.get(t+"/ds/g/WxUser?condition[openId]="+e)}}}]),app.factory("swipe",[function(){return function(){setTimeout(function(){new Swiper(".swiper-container",{loop:!0,pagination:".swiper-pagination"})},10)}}]),app.factory("cart",[function(){return{totalPrice:function(e){for(var t=0,r=0;r<e.length;r++)e[r].selected&&(t+=parseFloat(e[r].singlePrice));return t},totalNum:function(e){for(var t=0,r=0;r<e.length;r++)e[r].selected&&(t+=e[r].num);return t},findSelected:function(e){for(var t=[],r=0;r<e.length;r++)e[r].selected&&t.push(e[r]);return t}}}]),app.factory("searchByName",["$http","host","$filter",function(e,t,r){return{search:function(r){return e.get(t+"/ds/search-price",{params:r})},rate:function(r){return e.get(t+"/ds/g/Exchange",{params:r})},concat:function(r){return e({method:"post",data:r,url:t+"/wx/contact-kf"})},changePrice:function(e){for(var t=0;t<e.length;t++)for(var n=0;n<e[t].parts.length;n++)for(var o=0;o<e[t].parts[n].prices.length;o++)e[t].parts[n].prices[o].changePrice=r("changRate")(e[t].parts[n].prices[o].price,e[t].parts[n].prices[o].currency),e[t].parts[n].prices[o].selected=0==o;return e}}}]),app.factory("searchPdf",["$http","host",function(e,t){return{search:function(r){return e.get(t+"/ds/search-pdf",{params:r})},concat:function(r){return e({method:"post",data:r,url:t+"/wx/contact-kf"})}}}]),app.factory("contact",["$http","host",function(e,t){return{submit:function(r){return e({method:"post",data:r,url:t+"/ds/wx-user/phone"})}}}]),app.factory("address_add",["$http","host",function(e,t){return{submit:function(r){return e({method:"post",data:r,url:t+"/ds/wx-user/receive-addr"})}}}]),app.factory("checkOrder",["$http","host",function(e,t){return{addOrder:function(r){return e({method:"post",data:r,url:t+"/ds/order"})}}}]),app.factory("order",["$http","host",function(e,t){return{getOrdersById:function(r){return e.get(t+"/ds/g/Order?condition[ownerOpenId]="+r)},getOrders:function(){return e.get(t+"/ds/g/Order")},expressed:function(r){return e({method:"post",data:r,url:t+"/ds/order/expressed"})}}}]);