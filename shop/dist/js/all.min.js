var app=angular.module("app",["ui.router","ngTouch"]);angular.module("ngTouch",[]).directive("ngTouchstart",function(){return{controller:["$scope","$element",function(e,t){function r(r){var o=t.attr("ng-touchstart");e.$apply(o)}t.bind("touchstart",r)}]}}).directive("ngTouch",function(){return{controller:["$scope","$element",function(e,t){var r,o,n,s;t.bind("touchstart",function(e){r=e.touches[0].pageX,o=e.touches[0].pageY}),t.bind("touchmove",function(e){n=e.touches[0].pageX,s=e.touches[0].pageY}),t.bind("touchend",function(c){if(n=n||r,s=s||o,Math.abs(r-n)<5&&Math.abs(o-s)<5){var a=t.attr("ng-touch");e.$apply(a)}})}]}}).directive("ngTouchmove",function(){return{controller:["$scope","$element",function(e,t){function r(e){e.preventDefault(),t.bind("touchmove",o),t.bind("touchend",n)}function o(r){var o=t.attr("ng-touchmove");e.$apply(o)}function n(e){e.preventDefault(),t.unbind("touchmove",o),t.unbind("touchend",n)}t.bind("touchstart",r)}]}}).directive("ngTouchend",function(){return{controller:["$scope","$element",function(e,t){function r(r){var o=t.attr("ng-touchend");e.$apply(o)}t.bind("touchend",r)}]}}),app.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(e,t,r){t.otherwise("/search-by-name"),e.state("home",{url:"/home",templateUrl:"dist/tpls/home.html",controller:"home"}).state("cart",{url:"/my-shopping-cart",templateUrl:"dist/tpls/cart.html",controller:"cart"}).state("order",{url:"/my-orders",cache:"false",templateUrl:"dist/tpls/order.html",controller:"order"}).state("checkOrder",{url:"/checkOrder",templateUrl:"dist/tpls/checkOrder.html",controller:"checkOrder"}).state("address",{url:"/address",templateUrl:"dist/tpls/address.html",controller:"address"}).state("address_add",{url:"/address_add",templateUrl:"dist/tpls/address_add.html",controller:"address_add"}).state("address_change",{url:"/address_change?_id",templateUrl:"dist/tpls/address_change.html",controller:"address_change"}).state("searchByName",{url:"/search-by-name",templateUrl:"dist/tpls/searchByName.html",controller:"searchByName"}).state("searchByPdf",{url:"/search-pdf",templateUrl:"dist/tpls/search-pdf.html",controller:"searchByPdf"}).state("contact",{url:"/my-contact",templateUrl:"dist/tpls/contact.html",controller:"contact"})}]),app.controller("index",["$scope","$location","weixin","dailog","searchByName",function(e,t,r,o,n){console.log(r.getUserInfo()),e.closeFix=function(){o.hide()},e.concat=function(){var e=r.getUserInfo().openId;n.concat({openId:e}).then(function(e){o.hideLoad(),"200"==e.status&&r.getMessage(r.getUserInfo().openId).success(function(e){"1"==e[0].subscribe?wx.closeWindow():location.href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzI3MTY2NjIwNg==&scene=124#wechat_redirect"})})}}]),app.controller("home",["$scope",function(e){}]),app.controller("cart",["$scope","cart","weixin","$rootScope","$state","$timeout",function(e,t,r,o,n,s){e.shops=r.getUserInfo().cart,e.reload=function(){e.totalPrice=t.totalPrice(e.shops),e.totalNum=t.totalNum(e.shops),r.setUserInfo("cart",e.shops)},e.addNum=function(t){e.shops[t].num++,e.changeNum(t)},e.subNum=function(t){e.shops[t].num--,e.shops[t].num<1&&(e.shops[t].num=1),e.changeNum(t)},e.changeSelect=function(t){e.shops[t].selected=!e.shops[t].selected,e.reload()},e.deleteShop=function(t){e.shops.splice(t,1),e.reload()},e.changeNum=function(t){for(var r=0;r<e.shops[t].prices.length;r++)e.shops[t].prices[r].selected=!1;for(var r=0;r<e.shops[t].prices.length;r++){if(parseInt(e.shops[t].prices[r].amount)<=parseInt(e.shops[t].num)&&e.shops[t].prices[r+1]&&parseInt(e.shops[t].prices[r+1].amount)>parseInt(e.shops[t].num))return e.shops[t].prices[r].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[r].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();if(e.shops[t].prices.length-1==r&&parseInt(e.shops[t].num)<e.shops[t].prices[0].amount)return e.shops[t].prices[0].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[r].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),void e.reload();e.shops[t].prices.length-1==r&&(e.shops[t].prices[r].selected=!0,e.shops[t].singlePrice=e.shops[t].prices[r].changePrice*e.shops[t].num,e.shops[t].singlePrice=e.shops[t].singlePrice.toFixed(2),e.reload())}},e.checkOrder=function(){o.selectShop=t.findSelected(e.shops),n.go("checkOrder")},e.reload();for(var c=0;c<e.shops.length;c++)e.changeNum(c)}]),app.controller("order",["$scope","order","weixin","$state","dailog",function(e,t,r,o,n){e.getOrder=function(){t.getOrdersById(r.getUserInfo().openId).then(function(t){n.hideLoad(),e.orders=t.data})},e.showCurrent=function(t){e.scrollTop=document.body.scrollTop,e.currentShop=e.orders[t],e.current=!0},e.hideCurrent=function(){e.current=!1,setTimeout(function(){document.body.scrollTop=e.scrollTop},100)},e.goback=function(){o.go(-1)},e.pay=function(e,t){t.stopPropagation(),r.pay(e)},e.showCancel=function(t,r){r.stopPropagation(),e.orders[t].cancel=!e.orders[t].cancel},e.cancelOrder=function(r){e.orders[r].reason&&t.cancel({orderId:e.orders[r].orderId,ownerOpenId:e.orders[r].ownerOpenId,reason:e.orders[r].reason}).success(function(t){n.hideLoad(),"ok"==t.msg&&e.getOrder()})},r.config(),e.current=!1,e.getOrder()}]),app.controller("checkOrder",["$scope","$rootScope","weixin","dailog","checkOrder","cart","$state",function(e,t,r,o,n,s,c){r.config(),e.shopPrice=function(){for(var t=0,r=0;r<e.shops.length;r++)t+=parseFloat(e.shops[r].singlePrice);return t},e.num=function(){for(var t=0,r=0;r<e.shops.length;r++)t+=parseInt(e.shops[r].num);return t},e.closeFix=function(){o.hide("order")},e.pay=function(){n.addOrder({buyer:{name:e.address.name,phone:e.address.phone,addr:e.address.addr,zipCode:e.address.zipCode},subOrders:a,totalPrice:100*e.shopTotalPrice,ownerOpenId:r.getUserInfo().openId,descr:a[0].partName}).then(function(e){o.hideLoad(),s.removeSelected(),c.go("order")})},t.currentAddr?e.address=t.currentAddr:r.getMessage(r.getUserInfo().openId).then(function(r){o.hideLoad(),t.AllAddr=r.data[0].receiveAddrs,e.address=t.AllAddr[0]}),e.shops=t.selectShop;for(var a=[],i=0;i<t.selectShop.length;i++){a[i]={},a[i].partName=t.selectShop[i].shopName,a[i].qty=t.selectShop[i].num;for(var d=0;d<t.selectShop[i].prices.length;d++)if(t.selectShop[i].prices[d].selected){a[i].price=t.selectShop[i].prices[d].changePrice;break}}e.shopTotalPrice=e.shopPrice(),e.totalNum=e.num()}]),app.controller("address",["$scope","weixin","$rootScope","$state","dailog",function(e,t,r,o,n){var s=t.getUserInfo().openId;t.getMessage(s).then(function(t){n.hideLoad(),e.address=t.data[0].receiveAddrs,r.AllAddr=e.address}),e.changeAddress=function(t){r.currentAddr=e.address[t],o.go("checkOrder")}}]),app.controller("address_add",["$scope","address","weixin","dailog",function(e,t,r,o){e.tel="",e.name="",e.address="",e.zipCode="",e.closeFix=function(){o.hide("address")},e.submit=function(){t.submit({openId:r.getUserInfo().openId,receiveAddr:{phone:e.tel,name:e.name,addr:e.address,zipCode:e.zipCode}}).then(function(e){o.hideLoad(),"ok"==e.data.msg&&o.show("新增成功")})}}]),app.controller("address_change",["$scope","weixin","dailog","$stateParams","address","$state",function(e,t,r,o,n,s){var c=t.getUserInfo().openId;t.getMessage(c).then(function(t){r.hideLoad();for(var n=0;n<t.data[0].receiveAddrs.length;n++)t.data[0].receiveAddrs[n]._id==o._id&&(e.address=t.data[0].receiveAddrs[n])}),e.submit=function(){n.submit({openId:t.getUserInfo().openId,receiveAddr:{_id:o._id,phone:e.address.phone,name:e.address.name,addr:e.address.addr,zipCode:e.address.zipCode}}).then(function(e){r.hideLoad(),"ok"==e.data.msg&&r.show("修改成功")})},e.closeFix=function(){r.hide(),s.go("address")}}]),app.controller("searchByName",["$scope","searchByName","$rootScope","weixin","dailog",function(e,t,r,o,n){e.showList=!1,e.noList=!1,e.lists=[],o.config(),t.rate().success(function(e){n.hideLoad(),r.rate=e,r.rate.push({name:"RMB",rate:100})}),e.submit=function(){e.searchName&&t.search({part:encodeURIComponent(e.searchName)}).success(function(t){n.hideLoad(),e.lists=e.getLists(t),console.log(e.lists)})},e.addToCart=function(t,r,s){var c=e.lists[t].list[r].parts[s];c.name=e.lists[t].list[r].name,c.shopName=e.lists[t].oldName,c.singlePrice=c.prices[0].changePrice,c.selected=!0;var a=o.getUserInfo().cart,i=e.hasShop(c.maker,c.name);i.msg?a[i.index].num++:(c.num=1,a.push(c)),o.setUserInfo("cart",a),n.show()},e.hasShop=function(e,t){for(var r=0;r<o.getUserInfo().cart.length;r++)if(o.getUserInfo().cart[r].maker==e&&o.getUserInfo().cart[r].name==t)return{msg:!0,index:r};return{msg:!1}},e.showItem=function(t){e.lists[t].show=!e.lists[t].show},e.getLists=function(r){var o=[],n=!1;if("not found"==r.msg)return e.showList=!1,void(e.noList=!0);for(var s=0;s<r.length;s++)if(!r[s].distributors||0==r[s].distributors.length&&0==r[s].icKeys.length&&0==r[s].icBuy.length)n||(e.showList=!1,e.noList=!0);else{n=!0,e.noList=!1,e.showList=!0;for(var c=0;c<r[s].icBuy.length;c++)"ic购商城"==r[s].icBuy[c].name?r[s].distributors.unshift(r[s].icBuy[c]):r[s].distributors.push(r[s].icBuy[c]);for(var c=0;c<r[s].icKeys.length;c++)"云汉芯城"==r[s].icKeys[c].name&&(r[s].icKeys[c].name="ic购商城",r[s].distributors.splice(0,0,r[s].icKeys[c]));for(var a=0;r[s].icKeys[a]&&r[s].icKeys[a];)t.hasItem(r[s].distributors,r[s].icKeys[a])||r[s].distributors.push(r[s].icKeys[a]),a++;var i=r[s].name,d=r[s].name.toUpperCase().indexOf(e.searchName.toUpperCase()),p=d+e.searchName.length,u=i.slice(0,d),l=i.slice(d,p),h=i.slice(p),f={list:t.changePrice(r[s].distributors),name:[u,l,h],oldName:i};o.push(f)}return o}}]),app.controller("searchByPdf",["$scope","searchPdf","dailog","weixin",function(e,t,r,o){e.lists=[],o.config(),e.submit=function(){e.searchPdf&&t.search({part:encodeURIComponent(e.searchPdf)}).success(function(t){if(e.lists=[],r.hideLoad(),"not found"==t.msg)return e.showList=!1,void(e.noList=!0);e.noList=!1,e.showList=!0;for(var o=0;o<t.length;o++){var n={name:t[o].name,list:t[o].pdfs2};e.lists.push(n)}})}}]),app.controller("contact",["$scope","contact","weixin","dailog",function(e,t,r,o){e.submit=function(){t.submit({openId:r.getUserInfo().openId,phone:e.tel}).then(function(t){o.hideLoad(),"ok"==t.data.msg?(e.success=!0,e.getPhone()):e.success=!1},function(){e.success=!1})},e.getPhone=function(){r.getMessage(r.getUserInfo().openId).success(function(t){o.hideLoad(),t[0].phone?(e.phone=t[0].phone,e.hasPhone=!0,e.placeholder="更新手机号码"):(e.hasPhone=!1,e.placeholder="请填写手机号码")})},e.success=!1,e.getPhone()}]),app.directive("swiper",function(){return{scope:{},restrict:"AE",template:'<div class="swiper-container"><div class="swiper-wrapper" ng-transclude></div><div class="swiper-pagination"></div></div>',transclude:!0}}),app.filter("changRate",["$rootScope",function(e){return function(t,r){for(var o=0;o<e.rate.length;o++)if(e.rate[o].name==r)return t=t*e.rate[o].rate/100,t.toFixed(2)}}]),app.constant("appId","wx72b8722be094d273"),app.constant("host","https://chip.jymao.com"),app.factory("dailog",["$state",function(e){return{show:function(e){var t=document.querySelector(".message"),r=document.querySelector(".message p");t.style.display="block",e&&(r.innerText=e)},hide:function(t){document.querySelector(".message").style.display="none",t&&e.go(t)},showLoad:function(){document.querySelector(".load").style.display="block"},hideLoad:function(){document.querySelector(".load").style.display="none"}}}]),app.factory("weixin",["appId","host","$http","dailog","$state","$timeout",function(e,t,r,o,n,s){return{url:"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+e+"&redirect_uri="+encodeURIComponent(window.location.href)+"&response_type=code&scope=snsapi_userinfo&state=123#wechat_redirect",isweixin:function(){return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)},getQueryString:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),r=window.location.search.substr(1).match(t);return null!=r?unescape(r[2]):null},getUser:function(e){var r=new XMLHttpRequest;r.open("POST",t+"/wx/code",!1),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status){var e=JSON.parse(r.responseText);e.cart=[],localStorage.setItem("MY_USER_INFO",JSON.stringify(e))}else console.error(r.statusText)},r.onerror=function(e){console.error(r.statusText)},r.send("code="+e)},getUserInfo:function(){return null!=localStorage.getItem("MY_USER_INFO")?JSON.parse(localStorage.getItem("MY_USER_INFO")):null!=this.getQueryString("code")?(this.getUser(this.getQueryString("code")),JSON.parse(localStorage.getItem("MY_USER_INFO"))):void(window.location.href=this.url)},setUserInfo:function(e,t){var r=this.getUserInfo();r[e]=t,localStorage.setItem("MY_USER_INFO",JSON.stringify(r))},getMessage:function(e){return o.showLoad(),r.get(t+"/ds/g/WxUser?condition[openId]="+e)},getNonceStr:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(36)})},getTs:function(){return Math.floor((new Date).getTime()/100).toString()},config:function(){var o=this.getNonceStr(),n=this.getTs();r.get(t+"/wx/js-api-sign",{params:{noncestr:o,ts:n,url:encodeURIComponent(location.href)}}).success(function(t){wx.config({debug:!1,appId:e,timestamp:n,nonceStr:o,signature:t.sign,jsApiList:["closeWindow","chooseWXPay"]})})},pay:function(e){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",r,function(e){n.go("order"),s(function(){location.reload()},300)})}var r={};this.getPayOption(e).success(function(e){r=e,"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",t,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",t),document.attachEvent("onWeixinJSBridgeReady",t)):t()})},getPayOption:function(e){return r.post(t+"/ds/order/wx-pay-order",{orderId:e})}}}]),app.factory("cart",["weixin",function(e){return{totalPrice:function(e){for(var t=0,r=0;r<e.length;r++)e[r].selected&&(t+=parseFloat(e[r].singlePrice));return t},totalNum:function(e){for(var t=0,r=0;r<e.length;r++)e[r].selected&&(t+=e[r].num);return t},findSelected:function(e){for(var t=[],r=0;r<e.length;r++)e[r].selected&&t.push(e[r]);return t},removeSelected:function(){for(var t=e.getUserInfo().cart,r=t.length-1;r>=0;r--)t[r].selected&&t.splice(r,1);e.setUserInfo("cart",t)}}}]),app.factory("searchByName",["$http","host","$filter","dailog",function(e,t,r,o){return{search:function(r){return o.showLoad(),e.get(t+"/ds/search-price",{params:r})},rate:function(r){return e.get(t+"/ds/g/Exchange",{params:r})},concat:function(r){return o.showLoad(),e({method:"post",data:r,url:t+"/wx/contact-kf"})},changePrice:function(e){for(var t=0;t<e.length;t++)for(var o=0;o<e[t].parts.length;o++)if(e[t].parts[o].stock&&(e[t].parts[o].stock=parseInt(e[t].parts[o].stock)),e[t].parts[o].prices)for(var n=0;n<e[t].parts[o].prices.length;n++)e[t].parts[o].prices[n].changePrice=r("changRate")(e[t].parts[o].prices[n].price,e[t].parts[o].prices[n].currency),"ic购商城"==e[t].name&&(e[t].parts[o].prices[n].changePrice=(.95*e[t].parts[o].prices[n].changePrice).toFixed(2)),e[t].parts[o].prices[n].selected=0==n;return e},hasItem:function(e,t){for(var r=0;r<e.length;r++)if(e[r].name.trim()==t.name.trim())return!0;return!1}}}]),app.factory("searchPdf",["$http","host","dailog",function(e,t,r){return{search:function(o){return r.showLoad(),e.get(t+"/ds/search-pdf",{params:o})},concat:function(o){return r.showLoad(),e({method:"post",data:o,url:t+"/wx/contact-kf"})}}}]),app.factory("contact",["$http","host","dailog",function(e,t,r){return{submit:function(o){return r.showLoad(),e({method:"post",data:o,url:t+"/ds/wx-user/phone"})}}}]),app.factory("address",["$http","host","dailog",function(e,t,r){return{submit:function(o){return r.showLoad(),e({method:"post",data:o,url:t+"/ds/wx-user/receive-addr"})}}}]),app.factory("checkOrder",["$http","host","dailog",function(e,t,r){return{addOrder:function(o){return r.showLoad(),e({method:"post",data:o,url:t+"/ds/order"})}}}]),app.factory("order",["$http","host","dailog",function(e,t,r){return{getOrdersById:function(o){return r.showLoad(),e.get(t+"/ds/g/Order?condition[ownerOpenId]="+o)},getOrders:function(){return r.showLoad(),e.get(t+"/ds/g/Order")},expressed:function(o){return r.showLoad(),e({method:"post",data:o,url:t+"/ds/order/expressed"})},cancel:function(o){return r.showLoad(),e({method:"post",data:o,url:t+"/ds/order/cancel"})}}}]);